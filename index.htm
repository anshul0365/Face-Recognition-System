<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous"></script>
    <style>
        .div-video{
            text-align: center;
        }
        .downloadImage{
            display: none;
        }
        .liveStreamCanvas{
            transform: scaleX(-1);
        }
        video {
            transform: scaleX(-1);
            width: 840px;
        }
    </style>
</head>
<body>
    <div class="div-video">
        <video autoplay="true" id="liveStream"></video>
        <button id="capture" type="button">Capture</button>
        <button id="startStream" type="button">Start Stream</button>
        <input type="text" name="getName" id="getName">
        <button id="getNameBtn" type="button">Submit Name</button>
    </div>
    <div>
        <canvas id="liveStreamCanvas" class="liveStreamCanvas"></canvas>
    </div>

    <script type="text/javascript">
        var video = document.querySelector("#liveStream");
        var canvas  = document.querySelector('#liveStreamCanvas');
        var timeCount = 1;

        function startVideoStream(){
            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function (stream) {
                        video.srcObject = stream;
                        startCapturing()
                    })
                    .catch(function (error) {
                        console.log("Something went wrong!");
                    });
            }
        }
        function captureImage(){
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            var data = canvas.toDataURL('image/png');
            canvas.setAttribute('src', data);
            // img.src = canvas.toDataURL();
            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:5000/saveImage",
                headers: {
                    // 'Access-Control-Allow-Origin': '*'
                },
                data: {
                    imageData: data
                },
                success: function(data){
                    console.log(data);
                }
            });
        }

        $(document).ready(function () {
            startVideoStream();
        });

        function startCapturing(){
            var timer = setInterval(function () {
                captureImage();

                if (timeCount > 10) {
                    clearInterval(timer);
                    // return
                }
                console.log(timeCount);
                timeCount++;
            }, 1000); //time in millisecond
        }

        $('#startStream').click(function () {
            startVideoStream();
        });

        $('#capture').click(function(){
            captureImage();
        });

        $('#getNameBtn').click(function () {
            var input_name = document.getElementById('getName').value
            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:5000/getName",
                headers: {
                    // 'Access-Control-Allow-Origin': '*'
                },
                data: {
                    name: input_name
                },
                success: function (data) {
                    console.log(data);
                }
            });
        });

    </script>
</body>
</html>